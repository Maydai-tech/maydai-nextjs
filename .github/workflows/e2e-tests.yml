name: E2E Tests

on:
  push:
    branches:
      - preprod
  workflow_dispatch:

jobs:
  e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        id: e2e-tests
        continue-on-error: true
        run: |
          # Run tests - reporters configured in playwright.config.ts
          # JSON output goes to test-results.json, HTML to playwright-report/
          npx playwright test
          echo "Tests completed"
        env:
          # Supabase config
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          # Playwright config
          PLAYWRIGHT_BASE_URL: http://localhost:3000
          # Optional - for features that need these
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}

      - name: Parse test results
        if: always()
        id: parse-results
        run: |
          # Parse the JSON results file
          if [ -f test-results.json ]; then
            echo "Found test-results.json, parsing..."

            # Count tests by status (handling nested structure)
            PASSED=$(cat test-results.json | jq '[.suites[].suites[]?.specs[]?.tests[]? | select(.status == "expected")] | length' 2>/dev/null || echo "0")
            FAILED=$(cat test-results.json | jq '[.suites[].suites[]?.specs[]?.tests[]? | select(.status == "unexpected")] | length' 2>/dev/null || echo "0")
            SKIPPED=$(cat test-results.json | jq '[.suites[].suites[]?.specs[]?.tests[]? | select(.status == "skipped")] | length' 2>/dev/null || echo "0")
            FLAKY=$(cat test-results.json | jq '[.suites[].suites[]?.specs[]?.tests[]? | select(.status == "flaky")] | length' 2>/dev/null || echo "0")

            # If counts are still 0, try alternative structure (direct specs in suites)
            if [ "$PASSED" = "0" ] && [ "$FAILED" = "0" ] && [ "$SKIPPED" = "0" ]; then
              PASSED=$(cat test-results.json | jq '[.suites[].specs[]?.tests[]? | select(.status == "expected")] | length' 2>/dev/null || echo "0")
              FAILED=$(cat test-results.json | jq '[.suites[].specs[]?.tests[]? | select(.status == "unexpected")] | length' 2>/dev/null || echo "0")
              SKIPPED=$(cat test-results.json | jq '[.suites[].specs[]?.tests[]? | select(.status == "skipped")] | length' 2>/dev/null || echo "0")
              FLAKY=$(cat test-results.json | jq '[.suites[].specs[]?.tests[]? | select(.status == "flaky")] | length' 2>/dev/null || echo "0")
            fi

            # Build test list from nested structure
            TEST_LIST=$(cat test-results.json | jq -r '
              def process_suite:
                .title as $suite |
                (.specs[]? |
                  .title as $spec |
                  .tests[]? |
                  if .status == "expected" then "‚úÖ " + $spec
                  elif .status == "unexpected" then "‚ùå " + $spec
                  elif .status == "flaky" then "‚ö†Ô∏è " + $spec
                  else "‚è≠Ô∏è " + $spec
                  end
                ),
                (.suites[]? | process_suite);
              .suites[]? | process_suite
            ' 2>/dev/null | head -20 || echo "Could not parse test results")

            # Extract detailed error info for failed tests (for AI analysis)
            # Format: single line per error to avoid JSON issues in Slack payload
            ERROR_DETAILS=$(cat test-results.json | jq -r '
              def get_errors:
                .title as $suite |
                (.specs[]? |
                  .title as $spec |
                  .file as $file |
                  .tests[]? |
                  select(.status == "unexpected") |
                  .results[]? |
                  select(.error) |
                  "‚Ä¢ " + $spec + " | " + ($file | split("/") | last) + " | " + ((.error.message // "Unknown error") | gsub("\n"; " ") | gsub("\""; "") | .[0:200])
                ),
                (.suites[]? | get_errors);
              .suites[]? | get_errors
            ' 2>/dev/null | sort -u | head -10 || echo "")

            # If no errors found with nested structure, try flat structure
            if [ -z "$ERROR_DETAILS" ]; then
              ERROR_DETAILS=$(cat test-results.json | jq -r '
                .suites[]?.specs[]? |
                .title as $spec |
                .file as $file |
                .tests[]? |
                select(.status == "unexpected") |
                .results[]? |
                select(.error) |
                "‚Ä¢ " + $spec + " | " + ($file | split("/") | last) + " | " + ((.error.message // "Unknown error") | gsub("\n"; " ") | gsub("\""; "") | .[0:200])
              ' 2>/dev/null | sort -u | head -10 || echo "No error details available")
            fi

            # Build a simple summary for copy/paste
            FAILED_TESTS_SUMMARY=$(cat test-results.json | jq -r '
              def get_failed:
                (.specs[]? |
                  .title as $spec |
                  .file as $file |
                  .tests[]? |
                  select(.status == "unexpected") |
                  "‚Ä¢ " + $spec + " (" + ($file | split("/") | last) + ")"
                ),
                (.suites[]? | get_failed);
              .suites[]? | get_failed
            ' 2>/dev/null | sort -u | head -15 || echo "")

            if [ -z "$FAILED_TESTS_SUMMARY" ]; then
              FAILED_TESTS_SUMMARY=$(cat test-results.json | jq -r '
                .suites[]?.specs[]? |
                .title as $spec |
                .file as $file |
                .tests[]? |
                select(.status == "unexpected") |
                "‚Ä¢ " + $spec + " (" + ($file | split("/") | last) + ")"
              ' 2>/dev/null | sort -u | head -15 || echo "Aucun d√©tail disponible")
            fi

            echo "PASSED=$PASSED" >> $GITHUB_OUTPUT
            echo "FAILED=$FAILED" >> $GITHUB_OUTPUT
            echo "SKIPPED=$SKIPPED" >> $GITHUB_OUTPUT
            echo "FLAKY=$FLAKY" >> $GITHUB_OUTPUT
            echo "TEST_LIST<<EOF" >> $GITHUB_OUTPUT
            echo "$TEST_LIST" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "ERROR_DETAILS<<EOF" >> $GITHUB_OUTPUT
            echo "$ERROR_DETAILS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "FAILED_TESTS_SUMMARY<<EOF" >> $GITHUB_OUTPUT
            echo "$FAILED_TESTS_SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            echo "Parsed: $PASSED passed, $FAILED failed, $SKIPPED skipped, $FLAKY flaky"
          else
            echo "No test-results.json found"
            echo "PASSED=0" >> $GITHUB_OUTPUT
            echo "FAILED=0" >> $GITHUB_OUTPUT
            echo "SKIPPED=0" >> $GITHUB_OUTPUT
            echo "FLAKY=0" >> $GITHUB_OUTPUT
            echo "TEST_LIST=No test results file found" >> $GITHUB_OUTPUT
            echo "ERROR_DETAILS=No test results file found" >> $GITHUB_OUTPUT
            echo "FAILED_TESTS_SUMMARY=No test results file found" >> $GITHUB_OUTPUT
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: |
            playwright-report/
            test-results/
            test-results.json
          retention-days: 7

      - name: Deploy report to OVH server
        if: always()
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.OVH_SSH_KEY }}" | base64 -d > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H 57.130.47.254 >> ~/.ssh/known_hosts
          ssh -i ~/.ssh/id_ed25519 ubuntu@57.130.47.254 "mkdir -p /var/www/e2e-reports/${{ github.run_id }}"
          rsync -avz -e "ssh -i ~/.ssh/id_ed25519" --delete ./playwright-report/ ubuntu@57.130.47.254:/var/www/e2e-reports/${{ github.run_id }}/

      - name: Notify Slack on Success
        if: steps.e2e-tests.outcome == 'success'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚úÖ E2E Tests Passed",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref_name }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n`${{ github.sha }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Results:* ‚úÖ ${{ steps.parse-results.outputs.PASSED }} passed | ‚ö†Ô∏è ${{ steps.parse-results.outputs.FLAKY }} flaky | ‚è≠Ô∏è ${{ steps.parse-results.outputs.SKIPPED }} skipped"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Tests:*\n```${{ steps.parse-results.outputs.TEST_LIST }}```"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Run"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "üìä View Report"
                      },
                      "url": "http://57.130.47.254:8080/${{ github.run_id }}/"
                    }
                  ]
                }
              ]
            }

      - name: Build Slack failure payload
        if: steps.e2e-tests.outcome == 'failure'
        id: slack-payload
        env:
          FAILED_SUMMARY: ${{ steps.parse-results.outputs.FAILED_TESTS_SUMMARY }}
          ERROR_DETAILS: ${{ steps.parse-results.outputs.ERROR_DETAILS }}
          PASSED: ${{ steps.parse-results.outputs.PASSED }}
          FAILED: ${{ steps.parse-results.outputs.FAILED }}
          FLAKY: ${{ steps.parse-results.outputs.FLAKY }}
          SKIPPED: ${{ steps.parse-results.outputs.SKIPPED }}
          BRANCH: ${{ github.ref_name }}
          AUTHOR: ${{ github.actor }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          REPORT_URL: http://57.130.47.254:8080/${{ github.run_id }}/
        run: |
          # Use jq to build proper JSON with escaped strings
          jq -n \
            --arg failed_summary "üìã *Tests √©chou√©s:*\n$FAILED_SUMMARY" \
            --arg error_details "ü§ñ *Erreurs (copier/coller):*\n\`\`\`$ERROR_DETAILS\`\`\`" \
            --arg results "*R√©sultats:* ‚úÖ $PASSED | ‚ùå $FAILED | ‚ö†Ô∏è $FLAKY | ‚è≠Ô∏è $SKIPPED" \
            --arg branch "*Branch:*\n$BRANCH" \
            --arg author "*Author:*\n$AUTHOR" \
            --arg run_url "$RUN_URL" \
            --arg report_url "$REPORT_URL" \
            '{
              "blocks": [
                {"type": "section", "text": {"type": "mrkdwn", "text": "<!here>"}},
                {"type": "header", "text": {"type": "plain_text", "text": "‚ùå E2E Tests Failed", "emoji": true}},
                {"type": "section", "fields": [
                  {"type": "mrkdwn", "text": $branch},
                  {"type": "mrkdwn", "text": $author}
                ]},
                {"type": "section", "text": {"type": "mrkdwn", "text": $results}},
                {"type": "divider"},
                {"type": "section", "text": {"type": "mrkdwn", "text": $failed_summary}},
                {"type": "divider"},
                {"type": "section", "text": {"type": "mrkdwn", "text": $error_details}},
                {"type": "actions", "elements": [
                  {"type": "button", "text": {"type": "plain_text", "text": "üîç GitHub Actions"}, "url": $run_url},
                  {"type": "button", "text": {"type": "plain_text", "text": "üìä Rapport HTML"}, "style": "danger", "url": $report_url}
                ]}
              ]
            }' > slack-payload.json

      - name: Notify Slack on Failure
        if: steps.e2e-tests.outcome == 'failure'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload-file-path: slack-payload.json
