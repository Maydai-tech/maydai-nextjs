---
description:
globs:
alwaysApply: false
---
# Tests Unitaires - Syst√®me MayDai

## Structure des Tests

### Organisation des Tests
Les tests unitaires sont organis√©s dans le r√©pertoire `__tests__` √† c√¥t√© des modules test√©s :
```
app/usecases/[id]/utils/__tests__/
‚îú‚îÄ‚îÄ scoring-config.test.ts      # Tests de configuration des scores
‚îú‚îÄ‚îÄ risk-categories.test.ts     # Tests des cat√©gories de risque
‚îî‚îÄ‚îÄ score-calculator.test.ts    # Tests du calculateur de scores
```

### Configuration Jest
- [jest.config.js](mdc:jest.config.js) - Configuration Jest pour Next.js
- [jest.setup.js](mdc:jest.setup.js) - Setup global des tests
- [package.json](mdc:package.json) - Scripts et d√©pendances de test

## Modules Test√©s

### Score Calculator
- [app/usecases/[id]/utils/score-calculator.ts](mdc:app/usecases/[id]/utils/score-calculator.ts) - Logique de calcul des scores
- Tests couvrent :
  - Calculs de base avec diff√©rents types de r√©ponses (radio, checkbox, conditional)
  - R√©partition par cat√©gories de risque
  - Gestion des cas limites et erreurs

### Configuration de Scoring
- [app/usecases/[id]/utils/scoring-config.ts](mdc:app/usecases/[id]/utils/scoring-config.ts) - R√®gles de scoring
- Tests v√©rifient :
  - Coh√©rence des mappings de questions
  - Int√©grit√© des r√®gles de scoring
  - Calculs d'impacts par type de r√©ponse

### Cat√©gories de Risque
- [app/usecases/[id]/utils/risk-categories.ts](mdc:app/usecases/[id]/utils/risk-categories.ts) - D√©finitions des cat√©gories
- Tests v√©rifient :
  - Structure des cat√©gories (7 cat√©gories attendues)
  - Pond√©rations (doivent totaliser 1.0)
  - Mapping questions ‚Üí cat√©gories

## Commandes de Test

### Commandes Principales
```bash
npm test                    # Lancer tous les tests
npm run test:watch         # Mode surveillance
npm run test:coverage      # Rapport de couverture
```

### Tests Sp√©cifiques
```bash
npm test -- "scoring-config"     # Tests de configuration
npm test -- "score-calculator"   # Tests de calcul
npm test -- "risk-categories"    # Tests de cat√©gories
```

## D√©pendances de Test

### Compatibilit√© React 19
Les tests utilisent des versions compatibles avec React 19 :
- `@testing-library/react@^16.1.0` (compatible React 19)
- `@testing-library/jest-dom@^6.1.4`
- `@testing-library/dom@^10.0.0`
- `jest@^29.7.0`
- `ts-jest@^29.1.1`

### Configuration Jest
- Support TypeScript avec `ts-jest`
- Mapping des modules (`@/` ‚Üí racine du projet)
- Environment JSDOM pour tests de composants

## R√®gles de D√©veloppement avec Tests

### üö® R√àGLES CRITIQUES - √Ä RESPECTER ABSOLUMENT

#### 1. Tests Obligatoires pour Nouvelles Fonctionnalit√©s
**TOUTE nouvelle fonctionnalit√© DOIT √™tre accompagn√©e de tests unitaires :**
- ‚úÖ Nouvelles fonctions ‚Üí Tests obligatoires
- ‚úÖ Nouveaux composants ‚Üí Tests obligatoires  
- ‚úÖ Nouvelles API routes ‚Üí Tests obligatoires
- ‚úÖ Nouveaux utilitaires ‚Üí Tests obligatoires
- ‚úÖ Modifications de logique m√©tier ‚Üí Tests de r√©gression obligatoires

#### 2. Protection des Tests Existants
**INTERDICTION ABSOLUE de modifier les tests existants sans ordre explicite :**
- ‚ùå JAMAIS modifier automatiquement les fichiers `*.test.ts` ou `*.test.tsx`
- ‚ùå JAMAIS supprimer des tests existants
- ‚ùå JAMAIS changer les assertions sans demande explicite
- ‚úÖ SEULEMENT ajouter de nouveaux tests
- ‚úÖ SEULEMENT si demand√© explicitement par l'utilisateur

#### 3. Workflow de D√©veloppement
```
1. D√©velopper la fonctionnalit√©
2. Cr√©er les tests correspondants
3. V√©rifier que TOUS les tests passent (anciens + nouveaux)
4. Commit uniquement si 100% des tests passent
```

## Patterns de Test

### Structure des Tests
```typescript
describe('Module Name', () => {
  describe('Function Name', () => {
    test('should handle specific case', () => {
      // Arrange
      const input = mockData
      
      // Act
      const result = functionUnderTest(input)
      
      // Assert
      expect(result).toBe(expectedValue)
    })
  })
})
```

### Cas de Test Couverts
1. **Cas nominaux** - Fonctionnement normal
2. **Cas limites** - Donn√©es nulles, vides, incorrectes
3. **Int√©gration** - Interaction entre modules
4. **R√©gression** - Pr√©vention des r√©gressions futures

## Couverture de Code

### Objectifs de Couverture
- **100%** des fonctions de calcul de score
- **95%+** des cas limites et gestion d'erreurs
- **100%** des configurations et mappings

### M√©triques Actuelles
- ‚úÖ 37 tests passent
- ‚úÖ 3 suites de tests
- ‚úÖ 100% de r√©ussite

## Documentation

### Documentation des Tests
- [docs/TESTING.md](mdc:docs/TESTING.md) - Guide complet des tests
- [scripts/test-scoring.js](mdc:scripts/test-scoring.js) - Script de v√©rification

### Bonnes Pratiques

#### D√©veloppement Pilot√© par les Tests
- **Tests isol√©s et ind√©pendants** - Chaque test doit pouvoir s'ex√©cuter seul
- **Noms de tests descriptifs** - Expliquer clairement ce qui est test√©
- **Mocks appropri√©s** pour les d√©pendances externes
- **V√©rification compl√®te** des structures de donn√©es retourn√©es

#### R√®gles de Modification des Tests
- **CR√âER** de nouveaux tests pour les nouvelles fonctionnalit√©s
- **PROT√âGER** les tests existants - Ne JAMAIS les modifier sans demande explicite
- **VALIDER** que tous les tests passent avant chaque commit
- **DOCUMENTER** les raisons des changements de tests quand autoris√©s

#### Couverture et Qualit√©
- Viser une couverture de **100%** pour les nouvelles fonctions critiques
- Inclure des tests de **cas limites** et de **gestion d'erreurs**
- Tester les **interactions** entre modules
- Maintenir des tests de **non-r√©gression**

#### Avant de Committer
```bash
# TOUJOURS ex√©cuter avant un commit
npm test                # Tous les tests doivent passer
npm run test:coverage   # V√©rifier la couverture
```

#### En Cas de Test qui √âchoue
1. **NE PAS** modifier le test pour le faire passer
2. **CORRIGER** le code source pour respecter le test
3. **DEMANDER** explicitement si le test doit √™tre modifi√©
4. **JUSTIFIER** pourquoi le test existant serait incorrect
